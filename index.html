<script>
let running = false;
let inhale = 0;
let exhale = 0;
let count = 0;
let phase = 1;
let timer = null;
let unlocked = false;

function speakText(text) {
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "vi-VN";
  u.rate = 0.9;
  speechSynthesis.speak(u);
}

function speakNumber(num) {
  const u = new SpeechSynthesisUtterance(num.toString());
  u.lang = "vi-VN";
  u.rate = 0.9;
  speechSynthesis.speak(u);
}

function tick() {
  if (!running) return;

  count++;
  speakNumber(count);

  const limit = phase === 1 ? inhale : exhale;

  if (count >= limit) {
    count = 0;
    phase = phase === 1 ? 2 : 1;

    // Đọc chữ khi chuyển pha
    speakText(phase === 1 ? "Hít vào" : "Thở ra");
  }

  timer = setTimeout(tick, 1000);
}

function start() {
  if (running) return;

  inhale = parseInt(document.getElementById("n").value);
  exhale = inhale * 2;

  speechSynthesis.cancel();

  // Mở khoá âm thanh cho Safari iOS
  if (!unlocked) {
    const u = new SpeechSynthesisUtterance("1");
    u.lang = "vi-VN";
    u.volume = 0;
    speechSynthesis.speak(u);
    unlocked = true;
  }

  running = true;
  phase = 1;
  count = 0;

  // Đọc chữ & số đầu tiên NGAY khi bấm
  speakText("Hít vào");
  speakNumber(1);
  count = 1;

  timer = setTimeout(tick, 1000);
}

function stop() {
  running = false;
  clearTimeout(timer);
  speechSynthesis.cancel();
}
</script>
