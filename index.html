<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Đếm thở Khí Công (Đọc tắt)</title>
<style>
  body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9;}
  input { padding: 8px; width: 60px; text-align: center; font-size: 18px; border-radius: 5px; border: 1px solid #ccc;}
  button { padding: 12px 24px; margin: 10px; cursor: pointer; font-size: 18px; border-radius: 5px; border: none; background-color: #007bff; color: white;}
  button:active { background-color: #0056b3; }
  button.stop { background-color: #dc3545; }
  #status { font-size: 30px; margin-top: 30px; font-weight: bold; color: #333; height: 40px;}
  #counter { font-size: 80px; color: #007bff; margin: 10px 0; font-weight: bold;}
  .tutorial { font-size: 14px; color: #666; margin-bottom: 20px;}
</style>
</head>
<body>

<h2>Bài thở thải độc tố</h2>
<h2>Hít mũi 1 - Thở miệng 2</h2>
<p class="tutorial">Chế độ đọc tắt: "Hai mốt", "Hai hai", "Hai ba"...</p>

<p>Hít vào (giây)</p>
<input id="n" type="number" value="15" min="1">

<p>Thời gian tập (phút)</p>
<input id="minutes" type="number" value="10" min="1">

<div id="status">Sẵn sàng</div>
<div id="counter">--</div>

<br>
<button onclick="start()">Bắt đầu</button>
<button class="stop" onclick="stop()">Dừng</button>

<script>
let timer = null;       
let currentCount = 0;   
let currentPhase = 1;   
let phaseLimit = 0;     
let endTime = 0;
let unlocked = false;

// --- HÀM MỚI: Chuyển số thành văn nói tắt ---
function docSoNganGon(n) {
    if (n < 20) return n.toString(); // Dưới 20 để máy tự đọc (Mười lăm, Mười sáu...)
    
    const chuc = Math.floor(n / 10);
    const donvi = n % 10;
    
    let tuChuc = chuc.toString(); // Mặc định là số
    // Chuyển số hàng chục thành chữ (nếu cần thiết, nhưng google voice đọc số đơn lẻ tốt)
    // Google voice đọc "2" là "hai", "3" là "ba" -> OK
    
    let tuDonVi = "";
    
    if (donvi === 0) return chuc + " mươi"; // 20 -> Hai mươi (Vẫn nhanh)
    
    switch (donvi) {
        case 1: tuDonVi = "mốt"; break;
        case 4: tuDonVi = "tư"; break;
        case 5: tuDonVi = "lăm"; break;
        default: tuDonVi = donvi.toString();
    }
    
    return chuc + " " + tuDonVi; 
    // Ví dụ: "2 1" -> máy đọc "Hai một" (không hay bằng Hai mốt)
    // Nên ta return "2 mốt" -> máy đọc "Hai mốt"
}

function speak(text) {
  speechSynthesis.cancel(); 

  const u = new SpeechSynthesisUtterance(text);
  u.lang = "vi-VN";
  
  // Tinh chỉnh tốc độ
  // Vì đã đọc tắt (ngắn hơn) nên để tốc độ 1.3 là vừa đẹp, không cần quá nhanh
  u.rate = 1.3; 

  speechSynthesis.speak(u);
}

function updateDisplay(text, countDisplay) {
  document.getElementById("status").innerText = text;
  document.getElementById("counter").innerText = countDisplay;
}

function tick() {
  if (Date.now() >= endTime) {
    stop();
    speak("Xong");
    updateDisplay("Hoàn thành", "OK");
    return;
  }

  if (currentCount === 0) {
    if (currentPhase === 1) {
       speak("Hít"); 
       updateDisplay("Đang Hít vào...", "Hít");
    } else {
       speak("Thở"); 
       updateDisplay("Đang Thở ra...", "Thở");
    }
  } else {
    // SỬ DỤNG HÀM ĐỌC TẮT
    let textToRead = docSoNganGon(currentCount);
    speak(textToRead);
    updateDisplay(currentPhase === 1 ? "Hít vào" : "Thở ra", currentCount);
  }

  currentCount++;

  if (currentCount > phaseLimit) {
    switchPhase();
  }
}

function switchPhase() {
  currentPhase = (currentPhase === 1) ? 2 : 1;
  currentCount = 0; 
  
  const baseN = parseInt(document.getElementById("n").value);
  if (currentPhase === 1) {
    phaseLimit = baseN; 
  } else {
    phaseLimit = baseN * 2; 
  }
}

function start() {
  if (timer) return; 

  const minutes = parseInt(document.getElementById("minutes").value);
  endTime = Date.now() + minutes * 60 * 1000;
  
  currentPhase = 1; 
  currentCount = 0;
  phaseLimit = parseInt(document.getElementById("n").value);

  if (!unlocked) {
    const u = new SpeechSynthesisUtterance("");
    speechSynthesis.speak(u);
    unlocked = true;
  }

  tick();
  timer = setInterval(tick, 1000);
}

function stop() {
  clearInterval(timer);
  timer = null;
  speechSynthesis.cancel(); 
  updateDisplay("Đã dừng", "--");
}
</script>

</body>
</html>
