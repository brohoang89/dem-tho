<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Đếm thở Thải độc (Liền mạch)</title>
<style>
  body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9;}
  input { padding: 8px; width: 60px; text-align: center; font-size: 18px; border-radius: 5px; border: 1px solid #ccc;}
  button { padding: 12px 24px; margin: 10px; cursor: pointer; font-size: 18px; border-radius: 5px; border: none; background-color: #007bff; color: white;}
  button:active { background-color: #0056b3; }
  button.stop { background-color: #dc3545; }
  #status { font-size: 30px; margin-top: 30px; font-weight: bold; color: #333; height: 40px;}
  #counter { font-size: 80px; color: #007bff; margin: 10px 0; font-weight: bold;}
  .tutorial { font-size: 14px; color: #666; margin-bottom: 20px;}
  .ratio-info { background: #e9ecef; padding: 10px; display: inline-block; border-radius: 8px; margin-bottom: 20px;}
</style>
</head>
<body>

<h2>Bài thở thải độc tố</h2>
<div class="ratio-info">
    Tỷ lệ: Hít mũi (1) - Thở miệng (2)
</div>
<p class="tutorial">Quy tắc: "Hít... Hai... Ba..."</p>

<p>Thời gian Hít vào (giây)</p>
<input id="n" type="number" value="5" min="1">

<p>Thời gian tập (phút)</p>
<input id="minutes" type="number" value="10" min="1">

<div id="status">Sẵn sàng</div>
<div id="counter">--</div>

<br>
<button onclick="start()">Bắt đầu</button>
<button class="stop" onclick="stop()">Dừng</button>

<script>
let timer = null;       
let currentCount = 1;   // Bắt đầu từ 1
let phaseIndex = 0;     // 0: Hít, 1: Thở
let phaseLimit = 0;     
let endTime = 0;
let unlocked = false;

// Cấu hình các pha cho bài Thải độc (1-2)
const phases = [
    { name: "Hít", label: "Hít vào", ratio: 1 },
    { name: "Thở", label: "Thở ra", ratio: 2 }
];

// --- HÀM ĐỌC SỐ NGẮN GỌN ---
function docSoNganGon(n) {
    if (n < 20) return n.toString(); 
    
    const chuc = Math.floor(n / 10);
    const donvi = n % 10;
    let tuDonVi = "";
    
    if (donvi === 0) return chuc + " mươi"; 
    
    switch (donvi) {
        case 1: tuDonVi = "mốt"; break;
        case 4: tuDonVi = "tư"; break;
        case 5: tuDonVi = "lăm"; break;
        default: tuDonVi = donvi.toString();
    }
    
    return chuc + " " + tuDonVi; 
}

function speak(text) {
  speechSynthesis.cancel(); 
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "vi-VN";
  u.rate = 1.3; 
  speechSynthesis.speak(u);
}

function updateDisplay(text, countDisplay) {
  document.getElementById("status").innerText = text;
  document.getElementById("counter").innerText = countDisplay;
}

function tick() {
  if (Date.now() >= endTime) {
    stop();
    speak("Xong");
    updateDisplay("Hoàn thành", "OK");
    return;
  }

  const currentPhaseConfig = phases[phaseIndex];

  // --- LOGIC LIỀN MẠCH ---
  if (currentCount === 1) {
    // Giây thứ 1: Đọc tên lệnh (Hít/Thở) thay vì số 1
    speak(currentPhaseConfig.name); 
    updateDisplay(currentPhaseConfig.label, currentPhaseConfig.name);
  } else {
    // Giây thứ 2 trở đi: Đọc số
    let textToRead = docSoNganGon(currentCount);
    speak(textToRead);
    updateDisplay(currentPhaseConfig.label, currentCount);
  }

  currentCount++;

  // Kiểm tra chuyển pha
  if (currentCount > phaseLimit) {
    switchPhase();
  }
}

function switchPhase() {
  // Đảo pha: 0 -> 1 -> 0 -> 1...
  phaseIndex = (phaseIndex + 1) % 2;
  
  // Reset về 1 để nhịp sau đọc lệnh luôn
  currentCount = 1; 
  
  const baseTime = parseInt(document.getElementById("n").value);
  phaseLimit = baseTime * phases[phaseIndex].ratio;
}

function start() {
  if (timer) return; 

  const minutes = parseInt(document.getElementById("minutes").value);
  endTime = Date.now() + minutes * 60 * 1000;
  
  phaseIndex = 0; 
  currentCount = 1; // Bắt đầu từ 1
  
  const baseTime = parseInt(document.getElementById("n").value);
  phaseLimit = baseTime * phases[0].ratio;

  if (!unlocked) {
    const u = new SpeechSynthesisUtterance("");
    speechSynthesis.speak(u);
    unlocked = true;
  }

  tick();
  timer = setInterval(tick, 1000);
}

function stop() {
  clearInterval(timer);
  timer = null;
  speechSynthesis.cancel(); 
  updateDisplay("Đã dừng", "--");
}
</script>

</body>
</html>
