<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Đếm thở</title>
</head>
<body>

<p>Nhập số giây hít vào</p>
<input id="n" type="number" value="5" min="1">
<br><br>
<button onclick="start()">Bắt đầu</button>
<button onclick="stop()">Dừng</button>

<script>
let inhale = 0;
let exhale = 0;
let phase = 1; // 1 = hít, 2 = thở
let count = 0;
let running = false;
let unlocked = false;

function speak(text, callback) {
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "vi-VN";
  u.rate = 0.9;
  u.onend = () => {
    if (callback) callback();
  };
  speechSynthesis.speak(u);
}

function startPhase() {
  if (!running) return;

  const label = phase === 1 ? "Hít vào" : "Thở ra";
  speak(label, () => {
    setTimeout(() => {
      count = 1;
      speak(count.toString(), nextCount);
    }, 500); // nghỉ 0.5s sau chữ
  });
}

function nextCount() {
  if (!running) return;

  const limit = phase === 1 ? inhale : exhale;

  if (count >= limit) {
    phase = phase === 1 ? 2 : 1;
    setTimeout(startPhase, 1000);
    return;
  }

  setTimeout(() => {
    count++;
    speak(count.toString(), nextCount);
  }, 1000);
}

function start() {
  if (running) return;

  inhale = parseInt(document.getElementById("n").value);
  exhale = inhale * 2;

  speechSynthesis.cancel();

  // mở khoá audio iOS
  if (!unlocked) {
    const u = new SpeechSynthesisUtterance("1");
    u.volume = 0;
    speechSynthesis.speak(u);
    unlocked = true;
  }

  running = true;
  phase = 1;
  startPhase();
}

function stop() {
  running = false;
  speechSynthesis.cancel();
}
</script>


</body>
</html>
