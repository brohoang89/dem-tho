<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Đếm thở Khí Công (Tốc độ thích ứng)</title>
<style>
  body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9;}
  input { padding: 8px; width: 60px; text-align: center; font-size: 18px; border-radius: 5px; border: 1px solid #ccc;}
  button { padding: 12px 24px; margin: 10px; cursor: pointer; font-size: 18px; border-radius: 5px; border: none; background-color: #007bff; color: white;}
  button:active { background-color: #0056b3; }
  button.stop { background-color: #dc3545; }
  #status { font-size: 30px; margin-top: 30px; font-weight: bold; color: #333; height: 40px;}
  #counter { font-size: 80px; color: #007bff; margin: 10px 0; font-weight: bold;}
  .tutorial { font-size: 14px; color: #666; margin-bottom: 20px;}
</style>
</head>
<body>

<h2>Đếm thở Khí Công</h2>
<p class="tutorial">Máy sẽ tự động đọc nhanh hơn với các số dài (ví dụ: mười lăm)</p>

<p>Hít vào (giây)</p>
<input id="n" type="number" value="5" min="1">

<p>Thời gian tập (phút)</p>
<input id="minutes" type="number" value="10" min="1">

<div id="status">Sẵn sàng</div>
<div id="counter">--</div>

<br>
<button onclick="start()">Bắt đầu</button>
<button class="stop" onclick="stop()">Dừng</button>

<script>
let timer = null;       
let currentCount = 0;   
let currentPhase = 1;   // 1: Hít, 2: Thở
let phaseLimit = 0;     
let endTime = 0;
let unlocked = false;

// --- HÀM QUAN TRỌNG: Tự động chỉnh tốc độ ---
function speak(text) {
  speechSynthesis.cancel(); // Ngắt lời cũ ngay lập tức

  const u = new SpeechSynthesisUtterance(text);
  u.lang = "vi-VN";
  
  // LOGIC TỰ ĐỘNG TĂNG TỐC
  // Nếu text là số (ví dụ "1", "15")
  if (!isNaN(text)) {
      const num = parseInt(text);
      if (num < 10) {
          u.rate = 1.2; // Số nhỏ (1 chữ): Đọc hơi nhanh chút cho gọn (1.2x)
      } else {
          u.rate = 1.6; // Số lớn (2 chữ trở lên "Mười lăm"): Đọc rất nhanh (1.6x)
      }
  } else {
      // Nếu là chữ (Hít vào / Thở ra)
      // "Hít vào" khá ngắn, "Thở ra" cũng ngắn, nhưng để an toàn ta để 1.4
      u.rate = 1.4; 
  }

  // Fallback: Trên một số trình duyệt mobile, rate quá cao có thể bị lỗi, 
  // nên ta chặn trần ở mức 2.0 (nhanh gấp đôi là tối đa nghe rõ)
  if (u.rate > 2.0) u.rate = 2.0;

  speechSynthesis.speak(u);
}

function updateDisplay(text, countDisplay) {
  document.getElementById("status").innerText = text;
  document.getElementById("counter").innerText = countDisplay;
}

function tick() {
  if (Date.now() >= endTime) {
    stop();
    speak("Xong");
    updateDisplay("Hoàn thành", "OK");
    return;
  }

  if (currentCount === 0) {
    if (currentPhase === 1) {
       speak("Hít"); // Đổi text ngắn lại cho gọn
       updateDisplay("Đang Hít vào...", "Hít");
    } else {
       speak("Thở"); // Đổi text ngắn lại cho gọn
       updateDisplay("Đang Thở ra...", "Thở");
    }
  } else {
    speak(currentCount.toString());
    updateDisplay(currentPhase === 1 ? "Hít vào" : "Thở ra", currentCount);
  }

  currentCount++;

  if (currentCount > phaseLimit) {
    switchPhase();
  }
}

function switchPhase() {
  currentPhase = (currentPhase === 1) ? 2 : 1;
  currentCount = 0; 
  
  const baseN = parseInt(document.getElementById("n").value);
  if (currentPhase === 1) {
    phaseLimit = baseN; 
  } else {
    phaseLimit = baseN * 2; 
  }
}

function start() {
  if (timer) return; 

  const minutes = parseInt(document.getElementById("minutes").value);
  endTime = Date.now() + minutes * 60 * 1000;
  
  currentPhase = 1; 
  currentCount = 0;
  phaseLimit = parseInt(document.getElementById("n").value);

  if (!unlocked) {
    const u = new SpeechSynthesisUtterance("");
    speechSynthesis.speak(u);
    unlocked = true;
  }

  tick();
  timer = setInterval(tick, 1000);
}

function stop() {
  clearInterval(timer);
  timer = null;
  speechSynthesis.cancel(); 
  updateDisplay("Đã dừng", "--");
}
</script>

</body>
</html>
